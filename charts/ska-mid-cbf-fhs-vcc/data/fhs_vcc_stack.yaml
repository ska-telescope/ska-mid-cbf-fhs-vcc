name: fhsvcc
function: fhsvcc
domain: sensing
command: "FhsVccStackDeviceServer"
instances:
{{ range .Values.instances }}
  - {{ .name }}
{{- end }}
depends_on:
  - device: sys/database/2
readinessProbe:
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3
livenessProbe:
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3
server:
  name: "FhsVccStackDeviceServer"
  instances:
{{- range $index, $instance := .Values.instances }}
{{- $receptorId := (mod (sub $instance.deviceId 1) 3) }} # device id (1-144) to receptor id (0-2)
{{- $mac200 := $instance.mac200 | default dict }}
{{- $packetValidation := $instance.packetValidation | default dict }}
{{- $widebandInputBuffer := $instance.widebandInputBuffer | default dict }}
{{- $widebandFrequencyShifter := $instance.widebandFrequencyShifter | default dict }}
{{- $b123VccOsppfbChanneliser := $instance.b123VccOsppfbChanneliser | default dict }}
{{- $frequencySliceSelection := $instance.frequencySliceSelection | default dict }}
{{- $vccAllBands := $instance.vccAllBands | default dict }}
  - name: "{{ $instance.name }}"
    classes:
    - name: "Mac200"
      devices:
      - name: "fhs/mac200/{{ printf "%03d" $index }}"
        properties:
          - name: "MacType"
            values:
            - "200"
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $mac200.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $mac200.emulationMode | default $.Values.emulationMode }}"
          - name: "emulator_ipblock_id"
            values: 
            - "{{ $.Values.emulatorIpBlockIds.mac200 }}"
          - name: "emulator_id"
            values:
            - "{{ $instance.emulatorId }}"
          - name: "firmware_ipblock_id"
            values: 
            - "{{ printf $.Values.firmwareIpBlockIds.mac200 $receptorId }}"
    - name: "PacketValidation"
      devices:
      - name: "fhs/packetvalidation/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $packetValidation.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $packetValidation.emulationMode | default $.Values.emulationMode }}"
          - name: "emulator_ipblock_id"
            values: 
            - "{{ $.Values.emulatorIpBlockIds.packetValidation }}"
          - name: "emulator_id"
            values:
            - "{{ $instance.emulatorId }}"
          - name: "firmware_ipblock_id"
            values: 
            - "{{ printf $.Values.firmwareIpBlockIds.packetValidation $receptorId }}"
    - name: "WidebandInputBuffer"
      devices:
      - name: "fhs/wib/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $widebandInputBuffer.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $widebandInputBuffer.emulationMode | default $.Values.emulationMode }}"
          - name: "emulator_ipblock_id"
            values: 
            - "{{ $.Values.emulatorIpBlockIds.widebandInputBuffer }}"
          - name: "emulator_id"
            values:
            - "{{ $instance.emulatorId }}"
          - name: "firmware_ipblock_id"
            values: 
            - "{{ printf $.Values.firmwareIpBlockIds.widebandInputBuffer $receptorId }}"
          - name: "dish_id_poll_interval_s"
            values:
            - "3"
    - name: "WidebandFrequencyShifter"
      devices:
      - name: "fhs/wfs/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $widebandFrequencyShifter.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $widebandFrequencyShifter.emulationMode | default $.Values.emulationMode }}"
          - name: "emulator_ipblock_id"
            values: 
            - "{{ $.Values.emulatorIpBlockIds.widebandFrequencyShifter }}"
          - name: "emulator_id"
            values:
            - "{{ $instance.emulatorId }}"
          - name: "firmware_ipblock_id"
            values: 
            - "{{ printf $.Values.firmwareIpBlockIds.widebandFrequencyShifter $receptorId }}"
    - name: "B123VccOsppfbChanneliser"
      devices:
      - name: "fhs/vcc/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $b123VccOsppfbChanneliser.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $b123VccOsppfbChanneliser.emulationMode | default $.Values.emulationMode }}"
          - name: "emulator_ipblock_id"
            values: 
            - "{{ $.Values.emulatorIpBlockIds.b123Vcc }}"
          - name: "emulator_id"
            values:
            - "{{ $instance.emulatorId }}"
          - name: "firmware_ipblock_id"
            values: 
            - "{{ printf $.Values.firmwareIpBlockIds.b123Vcc $receptorId }}"
    - name: "FrequencySliceSelection"
      devices:
      - name: "fhs/frequency-slice-selection/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $frequencySliceSelection.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $frequencySliceSelection.emulationMode | default $.Values.emulationMode }}"
          - name: "emulator_ipblock_id"
            values: 
            - "{{ $.Values.emulatorIpBlockIds.frequencySliceSelection }}"
          - name: "emulator_id"
            values:
            - "{{ $instance.emulatorId }}"
          - name: "firmware_ipblock_id"
            values: 
            - "{{ printf $.Values.firmwareIpBlockIds.frequencySliceSelection $receptorId }}"
    - name: "VCCAllBandsController"
      devices:
      - name: "fhs/vcc-all-bands/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $vccAllBands.simulationMode | default $.Values.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $vccAllBands.emulationMode | default $.Values.emulationMode }}"
          - name: wideband_input_buffer_fqdn
            values:
            - "fhs/wib/{{ printf "%03d" $index }}"
          - name: vcc123_channelizer_fqdn
            values:
            - "fhs/vcc/{{ printf "%03d" $index }}"
          - name: fs_selection_fqdn
            values:
            - "fhs/frequency-slice-selection/{{ printf "%03d" $index }}"
          - name: wideband_frequency_shifter_fqdn
            values:
            - "fhs/wfs/{{ printf "%03d" $index }}"
          - name: mac_200_fqdn
            values:
            - "fhs/mac200/{{ printf "%03d" $index }}"
          - name: packet_validation_fqdn
            values:
            - "fhs/packetvalidation/{{ printf "%03d" $index }}"
          - name: vcc45_channelizer_fqdn # yet to be implemented
            values:
            - "placeholder"
{{- end }}

image:
  registry: "{{.Values.midcbf.image.registry}}"
  image: "{{.Values.midcbf.image.image}}"
  tag: "{{.Values.midcbf.image.tag}}"
  pullPolicy: "{{.Values.midcbf.image.pullPolicy}}"
environment_variables:
  - name: CONFIG_MAP_LOCATION
    value: "{{ .Values.hostInfo.configLocation }}"

volume:
  existingClaimName: "fhs-vcc-bitstream-pv"
  mountPath: "{{ .Values.lowLevel.bitstreamPath }}"
  readOnly: false

extraVolumes:
  - name: low-level-config-mount
    configMap: 
      name:  low-level-configmap
extraVolumeMounts:
  - name: low-level-config-mount
    mountPath: "{{ .Values.hostInfo.configLocation }}"
