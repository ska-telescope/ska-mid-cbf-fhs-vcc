name: fhsvcc
function: fhsvcc
domain: sensing
command: "FhsVccStackDeviceServer"
instances:
{{ range .Values.instances }}
  - {{ .name }}
{{- end }}
depends_on:
  - device: sys/database/2
readinessProbe:
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3
livenessProbe:
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3
server:
  name: "FhsVccStackDeviceServer"
  instances:
{{- range $index, $instance := .Values.instances }}
  - name: "{{ $instance.name }}"
    classes:
    - name: "PacketValidation"
      devices:
      - name: "fhs/packetvalidation/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.packetValidation.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $instance.packetValidation.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $instance.packetValidation.emulationMode }}"
    - name: "Mac200"
      devices:
      - name: "fhs/mac200/{{ printf "%03d" $index }}"
        properties:
          - name: "MacType"
            values:
            - "200"
          - name: "device_id"
            values:
            - "{{ $instance.mac200.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $instance.mac200.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $instance.mac200.emulationMode }}"
    - name: "B123VccOsppfbChanneliser"
      devices:
      - name: "fhs/vcc/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.b123VccOsppfbChanneliser.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $instance.b123VccOsppfbChanneliser.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $instance.b123VccOsppfbChanneliser.emulationMode }}"
    - name: "FrequencySliceSelection"
      devices:
      - name: "fhs/frequency-slice-selection/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.frequencySliceSelection.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $instance.frequencySliceSelection.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $instance.frequencySliceSelection.emulationMode }}"
    - name: "WidebandFrequencyShifter"
      devices:
      - name: "fhs/wfs/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.widebandFrequencyShifter.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $instance.widebandFrequencyShifter.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $instance.widebandFrequencyShifter.emulationMode }}"
    - name: "WidebandInputBuffer"
      devices:
      - name: "fhs/wib/{{ printf "%03d" $index }}"
        properties:
          - name: "device_id"
            values:
            - "{{ $instance.widebandInputBuffer.deviceId }}"
          - name: "device_version_num"
            values:
            - "0.0.1"
          - name: "device_gitlab_hash"
            values:
            - "0"
          - name: "config_location"
            values:
            - "{{ $.Values.hostInfo.configLocation }}"
          - name: "simulation_mode"
            values:
            - "{{ $instance.widebandInputBuffer.simulationMode }}"
          - name: "emulation_mode"
            values:
            - "{{ $instance.widebandInputBuffer.emulationMode }}"
{{- end }}

initContainers:
  - name: init-bitstream-downloader
    image: curlimages/curl
    command:
      - sh
      - -c
      - >
        if [ ! -f /app/mnt/bitstream/ska-mid-cbf-agilex-vcc-0.0.6.tar.gz ]; then
          curl -o /app/mnt/bistream/ska-mid-cbf-agilex-vcc-0.0.6.tar.gz https://artefact.skao.int/repository/raw-internal/ska-mid-cbf-agilex-vcc-0.0.6.tar.gz;
        fi
    volumeMounts:
      - name: volume-data
        mountPath: /app/mnt/bitstream

image:
  registry: "{{.Values.midcbf.image.registry}}"
  image: "{{.Values.midcbf.image.image}}"
  tag: "{{.Values.midcbf.image.tag}}"
  pullPolicy: "{{.Values.midcbf.image.pullPolicy}}"
envFrom:
  - configMapRef:
    name: low_level_config_map

extraVolumes:
  - name: low-level-config-mount
    configMap: 
      name:  low-level-configmap
extraVolumeMounts:
  - name: low-level-config-mount
    mountPath: "{{ .Values.hostInfo.configLocation }}"