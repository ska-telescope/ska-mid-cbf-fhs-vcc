{{ $localchart := . }}

{{- range $key, $deviceServer := .Values.deviceServers }}

  {{- $fileDeviceServerContextOrig := dict "name" $key "deviceServer" $deviceServer "image" $deviceServer.image "local" $localchart }}

  {{- range $index, $fhsVccUnit := $.Values.fhsVccUnits }}

    {{- $deviceServerConfig := $deviceServer }}

    {{- $fileDeviceServerTemp := deepCopy $fileDeviceServerContextOrig }}
    {{- $fileDeviceServerContext := merge $fileDeviceServerTemp (dict "fhsVccUnit" $fhsVccUnit) }}

    {{- $fileDeviceServer := tpl ($.Files.Get $deviceServer.file) (merge $fileDeviceServerContext $) | fromYaml }}

    {{- $_ := set $deviceServerConfig "instances" $fileDeviceServer.instances }}

    {{- $deviceServerTemp := deepCopy $deviceServer}}
    {{- $deviceServerConfig := merge $deviceServerTemp $fileDeviceServer }}

    {{- $context := dict "name" (printf "%s-%d" $key $index) "deviceserver" $deviceServerConfig "image" $deviceServerConfig.image "local" $localchart }}
    {{- $volume_context := dict "volume" $deviceServerConfig.volume "local" $localchart }}

    {{ template "ska-tango-util.multidevice-config.tpl" $context }}
    {{ template "ska-tango-util.multidevice-sacc-role.tpl" $context }}

    {{- if ((hasKey $deviceServerConfig "enabled") | ternary $deviceServerConfig.enabled true) }}
      {{ template "ska-tango-util.multidevice-job.tpl" $context }}
      # {{ template "ska-tango-util.deviceserver-pvc.tpl" $volume_context }}
      {{ template "ska-tango-util.multidevice-svc.tpl" $context }}
    {{- end }}

  {{- end }}
{{- end }}
