{{- define "ska-mid-cbf-fhs-vcc.deviceservers.yaml" -}}
{{ $localchart := . }}
{{- $name := $.Values.deviceServerName }}

{{- $fileDeviceServerContextOrig := dict "name" $name "local" $localchart }}

{{- $vccUnits := coalesce .VCCUnits $.Values.VCCUnits }}

{{- range $index, $fhsVccUnit := $vccUnits }}
  {{- $fileDeviceServerTemp := deepCopy $fileDeviceServerContextOrig }}
  {{- $fileDeviceServerContext := merge $fileDeviceServerTemp (dict "fhsVccUnit" $fhsVccUnit) }}

  {{- $fileDeviceServer := include "ska-mid-cbf-fhs-vcc.fhsVccStack" (merge $fileDeviceServerContext $) | fromYaml }}

  {{/*{{- $release := index $localchart "Release" }}
  {{- $_ := set $release "Namespace" (printf "%s-%d"  $.Values.hostInfo.namespace $index) }}*/}}

  {{- $context := dict "name" (printf "%s-%d" $name $index) "deviceserver" $fileDeviceServer "image" $fileDeviceServer.image "local" $localchart }}
  {{- $volume_context := dict "volume" $fileDeviceServer.volume "local" $localchart }}

  {{ template "ska-tango-util.multidevice-config.tpl" $context }}
  {{ template "ska-tango-util.multidevice-sacc-role.tpl" $context }}
  {{ template "ska-tango-util.multidevice-job.tpl" $context }}
  {{ template "ska-tango-util.multidevice-svc.tpl" $context }}

{{- end }}
{{- end -}}
